<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Interpretador Python</title>
  <!-- CodeMirror CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/theme/dracula.min.css">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 40px;
      background-color: #f2f4f8;
    }

    .editor-container {
      background-color: #1e1e2f;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      margin: 40px auto;
      max-width: 800px;
    }

    .code-header {
      background-color: #2c2c3c;
      color: #ccc;
      padding: 12px 20px;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-family: monospace;
    }

    .code-header .dots {
      display: flex;
      gap: 6px;
    }

    .dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .dot.red {
      background-color: #ff5f56;
    }

    .dot.yellow {
      background-color: #ffbd2e;
    }

    .dot.green {
      background-color: #27c93f;
    }

    .CodeMirror {
      border: none;
      height: auto;
      font-size: 14px;
      background-color: #1e1e2f;
      color: #dcdcdc;
    }

    .output-container {
      background-color: #1e1e2f;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
      margin: 40px auto;
      max-width: 800px;
      padding: 20px;
      color: #dcdcdc;
      font-family: 'Fira Code', monospace;
      font-size: 15px;
      line-height: 1.6;
    }

    pre {
      margin: 0;
      white-space: pre-wrap;
      max-height: 300px;
      overflow-y: auto;
    }

    .erro-linha {
      background-color: #ffdddd;
    }

    #spinner {
      display: none;
      margin-left: 10px;
      color: #666;
    }

    .button-container {
      margin: 10px 0;
      display: flex;
      gap: 10px;
    }

    button {
      padding: 8px 16px;
      cursor: pointer;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      transition: background-color 0.3s;
    }

    button:hover:not(:disabled) {
      background-color: #45a049;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    #clear-btn {
      background-color: #f44336;
    }

    #clear-btn:hover:not(:disabled) {
      background-color: #d32f2f;
    }

    .error {
      color: #d9534f;
    }

    .success {
      color: #5cb85c;
    }
  </style>
</head>

<body>

  <div class="editor-container">
    <div class="code-header">
      <div class="dots">
        <div class="dot red"></div>
        <div class="dot yellow"></div>
        <div class="dot green"></div>
      </div>
      <span>interprete.py</span>
    </div>
    <textarea id="python-editor"># Digite o seu código aqui
print("Olá, Mundo!")</textarea>
  </div>

  <div class="button-container">
    <button id="run-btn" disabled>Executar (Ctrl+Enter)</button>
    <button id="clear-btn" disabled>Limpar Saída</button>
    <span id="spinner">⏳ Executando...</span>
  </div>

  <div class="output-container">
    <pre id="saida">Carregando interpretador Python...</pre>
  </div>

  <!-- CodeMirror JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/codemirror.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/mode/python/python.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/matchbrackets.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.5/addon/edit/closebrackets.min.js"></script>
  <!-- Pyodide -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

  <script>
    let pyodide, editor;

    const runBtn = document.getElementById("run-btn");
    const clearBtn = document.getElementById("clear-btn");
    const outputEl = document.getElementById("saida");
    const spinner = document.getElementById("spinner");

    async function iniciar() {
      outputEl.textContent = "Carregando o interpretador Python...";
      try {
        pyodide = await loadPyodide({
          indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/",
          stdout: msg => {
            outputEl.textContent += msg;
            outputEl.scrollTop = outputEl.scrollHeight;
          },
          stderr: msg => {
            outputEl.textContent += msg;
            outputEl.scrollTop = outputEl.scrollHeight;
          }
        });

        editor = CodeMirror.fromTextArea(document.getElementById("python-editor"), {
          mode: "python",
          lineNumbers: true,
          indentUnit: 4,
          tabSize: 4,
          theme: "dracula",
          smartIndent: true,
          matchBrackets: true,
          autoCloseBrackets: true,
          extraKeys: {
            "Ctrl-Enter": () => executarCodigo()
          }
        });

        outputEl.textContent = "Pronto! Digite seu código e clique em Executar ou pressione Ctrl+Enter";
        outputEl.className = "success";
        runBtn.disabled = false;
        clearBtn.disabled = false;
      } catch (err) {
        outputEl.textContent = `Falha ao carregar o interpretador: ${err.message}`;
        outputEl.className = "error";
      }
    }

    function limparErros() {
      editor.eachLine(line => editor.removeLineClass(line, "background", "erro-linha"));
    }

    async function executarCodigo() {
      limparErros();
      outputEl.textContent = "";
      outputEl.className = "";
      runBtn.disabled = true;
      clearBtn.disabled = true;
      spinner.style.display = "inline";

      try {
        await pyodide.runPythonAsync(`
import sys, io
sys.stdout = io.StringIO()
sys.stderr = sys.stdout
        `);

        const execPromise = pyodide.runPythonAsync(editor.getValue());
        const timeout = new Promise((_, reject) => setTimeout(() => {
          reject(new Error('Tempo de execução excedido (5 segundos)'));
        }, 5000));

        await Promise.race([execPromise, timeout]);

        const out = await pyodide.runPythonAsync('sys.stdout.getvalue()');
        if (out) {
          outputEl.textContent = out;
        } else {
          outputEl.textContent = "Executado com sucesso (sem saída)";
          outputEl.className = "success";
        }
      } catch (err) {
        outputEl.textContent = `Erro: ${err.message}`;
        outputEl.className = "error";

        const lineMatch = err.message.match(/line (\d+)/);
        const tracebackMatch = err.message.match(/File "<exec>", line (\d+)/);
        const errorLine = lineMatch ? parseInt(lineMatch[1]) :
          tracebackMatch ? parseInt(tracebackMatch[1]) : null;

        if (errorLine) {
          editor.addLineClass(errorLine - 1, "background", "erro-linha");
          editor.scrollIntoView({ line: errorLine - 1, ch: 0 }, 100);
        }
      } finally {
        runBtn.disabled = false;
        clearBtn.disabled = false;
        spinner.style.display = "none";
      }
    }

    function limparSaida() {
      outputEl.textContent = "";
      outputEl.className = "";
      limparErros();
    }

    runBtn.addEventListener("click", executarCodigo);
    clearBtn.addEventListener("click", limparSaida);

    iniciar();
  </script>

</body>

</html>